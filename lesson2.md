> # 备注

## 课程介绍

Python性能优化相关的课程会有三节

1. Python性能分析
2. Python性能优化的技巧及原理
3. Python性能优化实践

第一节主要讲怎么做性能分析，介绍一些性能分析的工具
第二节讲怎么做性能优化，怎么去写效率更高的python代码
第三节结合具体的例子讲性能优化实践

## 背景知识

- 适当的Python开发基础
- 常用Python性能分析工具和方法
- 少量的C语言代码阅读调试知识
## 概述

今晚的课程分成四个部分，第一部分讲的是一个Python高效开发的原则，第二部分讲一些细节和对应的原理，重点是讲原理，在这个部分会涉及到部分C语言代码阅读和调试。第三部分讲Python脚本的运行方式，，第四部分讲高效数据处理工具。

#1. 少造轮子

少造轮子的意思是尽量不要在python上写库函数已经提供的算法。不要在Python上试图去完成复杂算法，因为复杂算法都是重计算的，Python层的计算能力和速度要比C语言慢太多。下边我结合两个例子来说明我要表达的意思。

## 1.1 二分查找

## 1.2 排序

#2. 使用效率更高的语法
##2.1
##2.2
##2.3 推导式
### 原因分析
之前的几次性能分析都是使用源码和调试的方式，这次换一种分析方式，字节码比较。

Python代码是先被编译为Python字节码后，再由Python虚拟机来执行Python字节码（pyc文件主要就是用于存储字节码指令 的）。一般来说一个Python语句会对应若干字节码指令，Python的字节码是一种类似汇编指令的中间语言

看下边这个图，左边的是正常的for append方式，右边是列表推导方式，直观上看右边的字节码更短。但是一个字节码指令并不是对应一个机器指 令（二进制指令），而是对应一段C代码，而不同的指令的性能不同，所以不能单独通过指令数量来判断代码的性能，而是要进一步去分析。

看左边的43到46load_name，load_attr，load_attr的内容是append，重点看右边这个图的46行，LIST_APPEND。左边这个图没有这一行，这个函数可以直接跳过Python层，直接进入C语言层的intPyList_Append(PyObject *op, Pyobject*newitem)

这里我们使用cProfile比较一下函数调用次数，可以看到右边比左边少很多次的python层的list.append。

列表推导在Python源码转换到字节码的过程中，使用的c语言来进行性能优化。因为你写一个python的for语句，for的内部是不知道你要进行什么操作的，而你写一个列表推导就明确知道要生成一个list了，所以明确直接使用LIST_APPEND，这比通用逻辑要快很多。



#3. Python脚本的运行方式

##3.1 Pypy
###代码的执行方式
代码有两种常见的执行方式，一种叫做编译执行，也就是直接将代码转换为CPU指令，然后连续执行这些指令，好处当然是非常快，一条多余的指令都没有；坏处则是难以支持许多动态特性。

一种叫做解释执行，也就是对每条语句在运行时用解释器去执行它相应的动作，好处是实现起来非常简单，也很容易添加新特性，坏处则是执行得非常慢，大部分CPU时间花在了解释器运行上面。



### JIT

JIT技术是两者的结合，首先让代码解释执行，同时收集信息，在收集到足够信息的时候，将代码动态编译成CPU指令，然后用CPU指令替代解释执行的过程，因为编译发生在马上要执行之前，所以叫做Just-In-Time Compiler。编译之后速度就是编译执行的速度了，比解释执行要快得多，所以运用JIT的PyPy某些情况下回避普通的CPython。



### 其他特性

- 内存占用  内存占用比CPython更低

- 沙盒   执行不可信的Python代码

- 无栈特性  适合编写高并发代码

### 安装

